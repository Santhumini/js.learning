var _ = require("underscore")
var csv = require("csvtojson")
var fs = require("fs");
const e = require("express");



var patientData = [];
function readPatient(path) {
    var text = fs.readFileSync(path, 'utf8')
    var p1 = JSON.parse(text);   //this key word is used to (covert string to json)  JSON.parse
    patientData.push(p1)
    //    console.log("File read successfully")

};

readPatient(".\\Diabetes_data\\Diabetes_patient1.json")
readPatient(".\\Diabetes_data\\Diabetes_patient2.json")
readPatient(".\\Diabetes_data\\Diabetes_patient3.json")
readPatient(".\\Diabetes_data\\Diabetes_patient4.json")


 OidDictionary={"2.16.840.1.113883.3.464.1003.198.12.1013":{"LOINC":["17856-6","4548-4","4549-2"]},"2.16.840.1.113883.3.526.3.1240":{"HCPCS Level II":["G0438","G0439"],"SNOMED-CT":["444971000124105","456201000124103"]},"2.16.840.1.113883.3.464.1003.101.12.1016":{"CPT":["99341","99342","99343","99344","99345","99347","99348","99349","99350"],"SNOMED-CT":["185460008","185462000","185466002","185467006","185468001","185470005","225929007","315205008","439708006","698704008","704126008"]},"2.16.840.1.113883.3.464.1003.101.12.1001":{"CPT":["99201","99202","99203","99204","99205","99212","99213","99214","99215"],"SNOMED-CT":["30346009","37894004","185463005","185464004","185465003","3391000175108","439740005"]},"2.16.840.1.113883.3.464.1003.101.12.1080":{"CPT":["98966","98967","98968","99441","99442","99443"],"SNOMED-CT":["185317003","314849005","386472008","386473003","401267002"]},"71007-9":{"LOINC":["71007-9"]},"2.16.840.1.113883.3.464.1003.101.12.1090":{"HCPCS Level II":["G9054","M1017"],"SNOMED-CT":["305284002","305381007","4901000124101","713281006"]},"2.16.840.1.113883.3.464.1003.198.12.1135":{"SNOMED-CT":["103735009","105402000","1841000124106","395669003","395670002","395694002","395695001","433181000124107","443761007"]},"2.16.840.1.113883.3.464.1003.101.12.1025":{"CPT":["99395","99396","99397"]},"2.16.840.1.113883.3.464.1003.101.12.1023":{"CPT":["99385","99386","99387"]},"2.16.840.1.113762.1.4.1108.15":{"SNOMED-CT":["385763009","385765002"]},"2.16.840.1.113883.3.464.1003.103.12.1001":{"ICD-10-CM":["E10.10","E10.11","E10.21","E10.22","E10.29","E10.311","E10.319","E10.321","E10.3211","E10.3212","E10.3213","E10.3219","E10.329","E10.3291","E10.3292","E10.3293","E10.3299","E10.331","E10.3311","E10.3312","E10.3313","E10.3319","E10.339","E10.3391","E10.3392","E10.3393","E10.3399","E10.341","E10.3411","E10.3412","E10.3413","E10.3419","E10.349","E10.3491","E10.3492","E10.3493","E10.3499","E10.351","E10.3511","E10.3512","E10.3513","E10.3519","E10.3521","E10.3522","E10.3523","E10.3529","E10.3531","E10.3532","E10.3533","E10.3539","E10.3541","E10.3542","E10.3543","E10.3549","E10.3551","E10.3552","E10.3553","E10.3559","E10.359","E10.3591","E10.3592","E10.3593","E10.3599","E10.36","E10.37X1","E10.37X2","E10.37X3","E10.37X9","E10.39","E10.40","E10.41","E10.42","E10.43","E10.44","E10.49","E10.51","E10.52","E10.59","E10.610","E10.618","E10.620","E10.621","E10.622","E10.628","E10.630","E10.638","E10.641","E10.649","E10.65","E10.69","E10.8","E10.9","E11.00","E11.01","E11.10","E11.11","E11.21","E11.22","E11.29","E11.311","E11.319","E11.321","E11.3211","E11.3212","E11.3213","E11.3219","E11.329","E11.3291","E11.3292","E11.3293","E11.3299","E11.331","E11.3311","E11.3312","E11.3313","E11.3319","E11.339","E11.3391","E11.3392","E11.3393","E11.3399","E11.341","E11.3411","E11.3412","E11.3413","E11.3419","E11.349","E11.3491","E11.3492","E11.3493","E11.3499","E11.351","E11.3511","E11.3512","E11.3513","E11.3519","E11.3521","E11.3522","E11.3523","E11.3529","E11.3531","E11.3532","E11.3533","E11.3539","E11.3541","E11.3542","E11.3543","E11.3549","E11.3551","E11.3552","E11.3553","E11.3559","E11.359","E11.3591","E11.3592","E11.3593","E11.3599","E11.36","E11.37X1","E11.37X2","E11.37X3","E11.37X9","E11.39","E11.40","E11.41","E11.42","E11.43","E11.44","E11.49","E11.51","E11.52","E11.59","E11.610","E11.618","E11.620","E11.621","E11.622","E11.628","E11.630","E11.638","E11.641","E11.649","E11.65","E11.69","E11.8","E11.9","E13.00","E13.01","E13.10","E13.11","E13.21","E13.22","E13.29","E13.311","E13.319","E13.321","E13.3211","E13.3212","E13.3213","E13.3219","E13.329","E13.3291","E13.3292","E13.3293","E13.3299","E13.331","E13.3311","E13.3312","E13.3313","E13.3319","E13.339","E13.3391","E13.3392","E13.3393","E13.3399","E13.341","E13.3411","E13.3412","E13.3413","E13.3419","E13.349","E13.3491","E13.3492","E13.3493","E13.3499","E13.351","E13.3511","E13.3512","E13.3513","E13.3519","E13.3521","E13.3522","E13.3523","E13.3529","E13.3531","E13.3532","E13.3533","E13.3539","E13.3541","E13.3542","E13.3543","E13.3549","E13.3551","E13.3552","E13.3553","E13.3559","E13.359","E13.3591","E13.3592","E13.3593","E13.3599","E13.36","E13.37X1","E13.37X2","E13.37X3","E13.37X9","E13.39","E13.40","E13.41","E13.42","E13.43","E13.44","E13.49","E13.51","E13.52","E13.59","E13.610","E13.618","E13.620","E13.621","E13.622","E13.628","E13.630","E13.638","E13.641","E13.649","E13.65","E13.69","E13.8","E13.9","O24.011","O24.012","O24.013","O24.019","O24.02","O24.03","O24.111","O24.112","O24.113","O24.119","O24.12","O24.13","O24.311","O24.312","O24.313","O24.319","O24.32","O24.33","O24.811","O24.812","O24.813","O24.819","O24.82","O24.83"],"ICD-9-CM":["250.00","250.01","250.02","250.03","250.10","250.11","250.12","250.13","250.20","250.21","250.22","250.23","250.30","250.31","250.32","250.33","250.40","250.41","250.42","250.43","250.50","250.51","250.52","250.53","250.60","250.61","250.62","250.63","250.70","250.71","250.72","250.73","250.80","250.81","250.82","250.83","250.90","250.91","250.92","250.93","357.2","362.01","362.02","362.03","362.04","362.05","362.06","362.07","366.41","648.00","648.01","648.02","648.03","648.04"],"SNOMED-CT":["190369008","237618001","314771006","314904008","102781000119107","104941000119109","104961000119108","109171000119104","110181000119105","138881000119106","138891000119109","138901000119108","138911000119106","138921000119104","138941000119105","1481000119100","1501000119109","1511000119107","1551000119108","190330002","190331003","190368000","190372001","190389009","199229001","199230006","23045005","237599002","237604008","28032008","28331000119107","31211000119101","31321000119102","313435000","313436004","314893005","314902007","314903002","359642000","368101000119109","368521000119107","368581000119106","41911000119107","420279001","420436000","420486006","420789003","420918009","421075007","421326000","421365002","421437000","421468001","421779007","421847006","421893009","422034002","422099009","422166005","427027005","427571000","428007007","44054006","46635009","60951000119105","609562003","609564002","609566000","609567009","60961000119107","60971000119101","60991000119100","691000119103","712882000","712883005","713702000","713703005","713705003","713706002","71441000119104","71721000119101","71791000119104","719216001","739681000","770098001","81531005","82541000119100","82551000119103","82571000119107","82581000119105","87921000119104","97331000119101","9859006"]},"2.16.840.1.113883.3.666.5.307":{"SNOMED-CT":["183452005","32485007","8715000"]},"2.16.840.1.113883.3.464.1003.118.12.1300":{"SNOMED-CT":["183240000","183241001","183248007","228869008","23366006","23562009","261323006","262177002","360006004","360008003","360299009","371786002","37874008","391685000","391686004","391687008","391688003","391689006","391880008","391881007","401953003","401954009","401955005","426160001","462987000","463093001","464002006","464157006","464405003","464443000","464571009","464752005","465159000","465556004","465565006","465921009","466182009","466193006","466213002","466229005","466284002","466316007","466317003","466322003","466331003","466337004","466340004","466344008","466351004","466364003","466365002","466366001","466378002","466381007","466407009","466464004","466466002","466473007","466477008","466486003","466494005","466524001","466533004","466538008","466550002","466553000","466576002","466607002","466616003","466619005","466644002","466671002","466695000","466699006","466721007","466739003","466758007","466786004","466809001","466813008","466851008","466871004","466889003","466926008","466927004","466938004","466947007","466966007","466986006","466989004","466999009","467018005","467065004","467077009","467095007","467137003","467155007","467163008","469361005","469860004","470119002","470174002","58938008","66435007","700593005","700705005","700910000","702172008","702173003","705404007","705406009","705419008","705421003","705422005","705423000","705425007","705426008","705427004","705428009","706180003","714700001","71545009","781471009","87405001"]},"2.16.840.1.113883.3.464.1003.113.12.1074":{"ICD-10-CM":["L89.001","L89.002","L89.003","L89.004","L89.006","L89.009","L89.010","L89.011","L89.012","L89.013","L89.014","L89.016","L89.019","L89.020","L89.021","L89.022","L89.023","L89.024","L89.026","L89.029","L89.100","L89.101","L89.102","L89.103","L89.104","L89.106","L89.109","L89.110","L89.111","L89.112","L89.113","L89.114","L89.116","L89.119","L89.120","L89.121","L89.122","L89.123","L89.124","L89.126","L89.129","L89.130","L89.131","L89.132","L89.133","L89.134","L89.136","L89.139","L89.140","L89.141","L89.142","L89.143","L89.144","L89.146","L89.149","L89.150","L89.151","L89.152","L89.153","L89.154","L89.156","L89.159","L89.200","L89.201","L89.202","L89.203","L89.204","L89.206","L89.209","L89.210","L89.211","L89.212","L89.213","L89.214","L89.216","L89.219","L89.220","L89.221","L89.222","L89.223","L89.224","L89.226","L89.229","L89.300","L89.301","L89.302","L89.303","L89.304","L89.306","L89.309","L89.310","L89.311","L89.312","L89.313","L89.314","L89.316","L89.319","L89.320","L89.321","L89.322","L89.323","L89.324","L89.326","L89.329","L89.40","L89.41","L89.42","L89.43","L89.44","L89.45","L89.46","L89.500","L89.501","L89.502","L89.503","L89.504","L89.506","L89.509","L89.510","L89.511","L89.512","L89.513","L89.514","L89.516","L89.519","L89.520","L89.521","L89.522","L89.523","L89.524","L89.526","L89.529","L89.600","L89.601","L89.602","L89.603","L89.604","L89.606","L89.609","L89.610","L89.611","L89.612","L89.613","L89.614","L89.616","L89.619","L89.620","L89.621","L89.622","L89.623","L89.624","L89.626","L89.629","L89.810","L89.811","L89.812","L89.813","L89.814","L89.816","L89.819","L89.890","L89.891","L89.892","L89.893","L89.894","L89.896","L89.899","L89.90","L89.91","L89.92","L89.93","L89.94","L89.95","L89.96","M62.50","M62.81","M62.84","W01.0XXA","W01.0XXD","W01.0XXS","W01.10XA","W01.10XD","W01.10XS","W01.110A","W01.110D","W01.110S","W01.111A","W01.111D","W01.111S","W01.118A","W01.118D","W01.118S","W01.119A","W01.119D","W01.119S","W01.190A","W01.190D","W01.190S","W01.198A","W01.198D","W01.198S","W06.XXXA","W06.XXXD","W06.XXXS","W07.XXXA","W07.XXXD","W07.XXXS","W08.XXXA","W08.XXXD","W08.XXXS","W10.0XXA","W10.0XXD","W10.0XXS","W10.1XXA","W10.1XXD","W10.1XXS","W10.2XXA","W10.2XXD","W10.2XXS","W10.8XXA","W10.8XXD","W10.8XXS","W10.9XXA","W10.9XXD","W10.9XXS","W18.00XA","W18.00XD","W18.00XS","W18.02XA","W18.02XD","W18.02XS","W18.09XA","W18.09XD","W18.09XS","W18.11XA","W18.11XD","W18.11XS","W18.12XA","W18.12XD","W18.12XS","W18.2XXA","W18.2XXD","W18.2XXS","W18.30XA","W18.30XD","W18.30XS","W18.31XA","W18.31XD","W18.31XS","W18.39XA","W18.39XD","W18.39XS","W19.XXXA","W19.XXXD","W19.XXXS","Y92.199","Z59.3","Z73.6","Z74.01","Z74.09","Z74.1","Z74.2","Z74.3","Z74.8","Z74.9","Z91.81","Z99.11","Z99.3","Z99.81","Z99.89"],"SNOMED-CT":["414188008","414189000","16728003","10637031000119106","10637071000119109","10637111000119102","10637151000119101","129588001","138371000119104","162845004","17886000","20902002","214436006","214437002","214438007","214439004","214441003","214442005","214443000","214444006","217082002","217083007","217084001","217086004","217088003","217090002","217092005","217093000","217094006","217142006","217154006","217155007","217156008","217157004","217158009","217173005","225558004","225562005","225563000","242109009","242389003","242390007","242391006","242392004","242395002","242396001","242413007","242414001","242419006","269699007","274918000","33036003","40104005","414190009","427849003","428484005","429621003","44188002","459821000124104","52702003","56307009","67223001","699214007","699215008","699216009","699218005","715504003","74541001","763829004","823018004","83468000","8960001000004106","90619006","92341000119107"]},"2.16.840.1.113883.3.464.1003.101.12.1088":{"CPT":["99504","99509"],"HCPCS Level II":["G0162","G0299","G0300","G0493","G0494","S0271","S0311","S9123","S9124","T1000","T1001","T1002","T1003","T1004","T1005","T1019","T1020","T1021","T1022","T1030","T1031"]},"2.16.840.1.113883.3.464.1003.113.12.1075":{"ICD-10-CM":["R26.0","R26.1","R26.2","R26.89","R26.9","R41.81","R53.1","R53.81","R53.83","R54","R62.7","R63.4","R63.6","R64"],"SNOMED-CT":["267031002","272060000","272062008","314109004","271875007","394616008","102492002","102568007","102891000","105501005","105503008","105504002","126013009","127378008","135834002","13791008","152921000119101","15634971000119107","16018391000119104","16018431000119109","160681005","160683008","160684002","160685001","160692006","160693001","160734000","160737007","161832001","161873000","161874006","162236007","162239000","163600007","163686004","163695007","16419651000119103","165243005","165244004","18726006","20940004","22090007","22325002","224960004","225612007","22631008","23042008","238108007","248269005","248278004","248279007","249888000","249937002","249938007","249939004","249940002","249941003","249942005","249943000","249946008","250002000","250003005","250015009","250029005","250032008","250033003","250034009","250038007","250043000","250044006","250045007","250048009","250052009","250054005","250991000119100","25136009","262285001","26544005","267024001","267032009","268964003","271795006","272036004","275313006","284529003","298283006","300948004","309249007","309257005","312444006","365884000","367391008","371028005","373931001","397776000","404904002","413121008","41786007","418073009","422868009","426977000","428116008","428264009","429091008","429487005","43005009","431524008","432559006","442099003","444042007","444932008","4468000","448765001","459821000124104","50314001","60631000119109","60651000119103","67141003","69161000119103","713512009","713514005","713568000","713655003","78119002","784317004","784318009","78691002","788876001","788900007","79021000119104","79031000119101","84229001","8510008","85711000119103","89201000119106","89362005","931000119107"]},"2.16.840.1.113883.3.464.1003.101.12.1087":{"CPT":["99201","99202","99203","99204","99205","99211","99212","99213","99214","99215","99241","99242","99243","99244","99245","99341","99342","99343","99344","99345","99347","99348","99349","99350","99381","99382","99383","99384","99385","99386","99387","99391","99392","99393","99394","99395","99396","99397","99401","99402","99403","99404","99411","99412","99429","99455","99456","99483"],"HCPCS Level II":["G0402","G0438","G0439","G0463","T1015"],"SNOMED-CT":["30346009","37894004","185463005","185464004","185465003","281036007","3391000175108","439740005","444971000124105","77406008","84251009"]},"2.16.840.1.113883.3.464.1003.101.12.1086":{"CPT":["99217","99218","99219","99220"]},"2.16.840.1.113883.3.464.1003.101.12.1010":{"CPT":["99281","99282","99283","99284","99285"],"SNOMED-CT":["4525004"]},"2.16.840.1.113883.3.464.1003.101.12.1084":{"CPT":["99304","99305","99306","99307","99308","99309","99310","99315","99316","99318","99324","99325","99326","99327","99328","99334","99335","99336","99337"],"SNOMED-CT":["112690009","183430001","183921001","304567001","304568006","305336008","305340004","305381007","306804001","36723004","449411000124106","449421000124103","449431000124100"]},"2.16.840.1.113883.3.464.1003.101.12.1083":{"CPT":["99221","99222","99223","99231","99232","99233","99238","99239","99251","99252","99253","99254","99255","99291"],"SNOMED-CT":["10378005","112689000","1505002","15584006","18083007","183450002","183452005","183481006","183487005","183488000","183489008","183491000","183492007","183493002","183494008","183495009","183496005","183497001","183498006","183499003","183500007","183501006","183502004","183503009","183504003","183505002","183506001","183507005","183508000","183509008","183510003","183511004","183512006","19951005","2252009","235313004","25986004","287927002","304566005","305337004","305338009","305339001","305341000","305342007","305350003","305354007","305355008","305356009","305357000","305358005","305359002","305360007","305361006","305362004","305363009","305364003","305365002","305366001","305367005","305368000","305369008","305370009","305371008","305372001","305374000","305375004","305376003","305377007","305378002","305379005","305380008","305382000","305383005","305384004","305385003","305386002","305387006","305388001","305389009","305390000","305391001","305392008","305393003","305394009","305395005","305396006","305397002","305399004","305400006","305401005","305402003","305403008","305404002","305405001","305406000","305407009","305408004","305409007","305410002","305411003","305412005","305413000","305414006","305415007","305416008","305417004","305418009","305419001","305420007","305421006","305422004","305423009","305424003","305425002","305426001","305427005","305428000","305429008","305430003","305431004","305432006","305433001","305434007","305435008","306732000","306803007","306967009","308251003","308252005","308253000","310361003","3241000175106","32485007","373113001","397769005","398162007","405614004","417005","432621000124105","442281000124108","447941000124106","448421000124105","448431000124108","448441000124103","448851000124103","4563007","45702004","47348005","48183000","50699000","51032003","51501005","5161006","52748007","60059000","63551005","699124006","70755000","71290004","73607007","74857009","76193006","76464004","78680009","81672003","82942009","8715000"]},"2.16.840.1.113883.3.464.1003.196.12.1510":{"RxNorm":["1100184","1308569","1599803","1599805","1805420","1805425","310436","310437","312835","312836","314214","314215","579148","725021","725023","860695","860707","860715","860901","996561","996571","996594","996603","996609","996615","996740","997220","997223","997226","997229"]},"2.16.840.1.113883.3.464.1003.101.12.1014":{"CPT":["99324","99325","99326","99327","99328","99334","99335","99336","99337"],"SNOMED-CT":["209099002","210098006"]},"2.16.840.1.113883.3.464.1003.101.12.1012":{"CPT":["99304","99305","99306","99307","99308","99309","99310","99315","99316","99318"],"SNOMED-CT":["18170008","207195004"]},"2.16.840.1.113883.3.117.1.7.1.209":{"SNOMED-CT":["428361000124107"]},"2.16.840.1.113883.3.117.1.7.1.207":{"SNOMED-CT":["428371000124100"]},"2.16.840.1.113883.3.464.1003.110.12.1082":{"ICD-10-CM":["A81.00","A81.01","A81.09","C25.0","C25.1","C25.2","C25.3","C25.4","C25.7","C25.8","C25.9","C71.0","C71.1","C71.2","C71.3","C71.4","C71.5","C71.6","C71.7","C71.8","C71.9","C77.0","C77.1","C77.2","C77.3","C77.4","C77.5","C77.8","C77.9","C78.00","C78.01","C78.02","C78.1","C78.2","C78.30","C78.39","C78.4","C78.5","C78.6","C78.7","C78.80","C78.89","C79.00","C79.01","C79.02","C79.10","C79.11","C79.19","C79.2","C79.31","C79.32","C79.40","C79.49","C79.51","C79.52","C79.60","C79.61","C79.62","C79.70","C79.71","C79.72","C79.81","C79.82","C79.89","C79.9","C91.00","C91.02","C92.00","C92.02","C93.00","C93.02","C93.90","C93.92","C93.Z0","C93.Z2","C94.30","C94.32","F01.50","F01.51","F02.80","F02.81","F03.90","F03.91","F04","F10.27","F10.96","F10.97","G10","G12.21","G20","G30.0","G30.1","G30.8","G30.9","G31.01","G31.09","G31.83","I09.81","I11.0","I12.0","I13.0","I13.11","I13.2","I50.1","I50.20","I50.21","I50.22","I50.23","I50.30","I50.31","I50.32","I50.33","I50.40","I50.41","I50.42","I50.43","I50.810","I50.811","I50.812","I50.813","I50.814","I50.82","I50.83","I50.84","I50.89","I50.9","J43.0","J43.1","J43.2","J43.8","J43.9","J68.4","J84.10","J84.112","J84.17","J84.170","J84.178","J96.10","J96.11","J96.12","J96.20","J96.21","J96.22","J96.90","J96.91","J96.92","J98.2","J98.3","K70.10","K70.11","K70.2","K70.30","K70.31","K70.40","K70.41","K70.9","K74.0","K74.00","K74.01","K74.02","K74.1","K74.2","K74.4","K74.5","K74.60","K74.69","N18.5","N18.6"],"SNOMED-CT":["143391000119109","698810000","230374002","235965006","255044008","448922007","690801000119108","128404006","13092008","192928003","195963002","230373008","700251005","700252003","708537005","188459004","57488007","62239001","66110007","100721000119109","100731000119107","10091002","101281000119107","101301000119106","101421000119107","10335000","10349009","103511000119103","103611000119102","104981000119104","10532003","105421000119105","105451000119102","106021000119105","10633002","10672271000119100","10676831000119101","107571000119101","107581000119103","10762071000119109","108101000119101","108131000119108","108201000119105","108211000119108","1082601000112109","109819003","109848009","109912006","111283005","111411000119103","111480006","11471000224106","116811000119106","116821000119104","120851000119104","120861000119102","120871000119108","120881000119106","120891000119109","120901000119108","12246561000119101","12246601000119101","12348006","123604002","123605001","123606000","12368000","123716002","123717006","127991000119101","128001000119105","128462008","128465005","130121000119104","13274008","13351431000119102","135091000119106","13839000","14070001","141991000119109","142001000119106","142011000119109","143401000119106","14700006","153891000119101","153931000119109","153941000119100","153951000119103","15629541000119106","15629591000119103","15629641000119107","15629741000119102","15662003","15781000119107","1581000119101","1591000119103","15956181000119102","15964701000119109","15999000","16003001","16055271000119107","16070004","16219201000119101","16260631000119101","162711000","162712007","16276361000119109","162974009","1651000119109","1661000119106","1671000119100","1681000119102","16838951000119100","16846004","1691000119104","17262008","17385007","1761006","1801000119106","181869007","187786003","187791002","187792009","187793004","187794005","187798008","188280007","188281006","188282004","188283009","188285002","188286001","188287005","188289008","188290004","188292007","188293002","188295009","188296005","188297001","188298006","188301005","188302003","188308004","188339002","188340000","188445006","188454009","188458007","188462001","188469005","188471005","188645002","188648000","188649008","19090001000004101","191449005","191451009","191452002","191454001","191455000","191457008","191458003","191459006","191461002","191463004","191464005","191465006","191466007","191471000","191493005","191494004","191519005","192926004","192927008","192929006","194767001","194779001","194781004","195111005","195112003","195114002","195957006","195958001","195959009","196026004","196028003","196125002","197279005","197291001","197293003","197294009","197296006","197299004","197301006","197303009","197305002","197310003","19943007","20091000175107","206586007","213215000","21861000","21921000119103","22381000119105","230156002","230258005","230265002","230266001","230267005","230268000","230269008","230271008","230272001","230280008","230282000","230283005","230285003","230286002","230287006","230288001","230289009","230299004","230300007","230301006","230372003","230499002","23341000119109","233674008","233675009","233677001","233713004","233724002","233725001","233726000","233737004","233758005","233761006","233765002","233924009","233940007","235875008","235881000","235895002","235896001","235897005","235899008","235901004","235902006","235966007","236433006","236434000","236435004","236436003","236512004","236513009","23958009","241861008","2421000119107","242862004","24700007","254609000","254611009","254612002","254938000","254940005","254955001","254969001","255088001","255112006","255118005","255119002","255121007","255123005","255124004","25544003","25772007","266355005","266356006","266368002","266468003","266469006","266470007","266471006","26852004","268612007","26929004","269473008","269616004","269617008","271440004","27156006","274088005","274282003","275266006","276259003","276514007","276826005","276828006","276836002","277461004","277505007","277638005","277639002","278051002","278433008","278857002","281004","281560004","285211000119102","285221000119109","285598005","285603002","285604008","285605009","285606005","285607001","285608006","285609003","285610008","285611007","285612000","285613005","285614004","285615003","285616002","285617006","285618001","285619009","285631006","285633009","285634003","285635002","285637005","285638000","285639008","285640005","285641009","285642002","285643007","285644001","285645000","285841000119104","286371000119107","286902000","288631000119104","2912004","30042003","301643003","302507002","303194003","303201005","304603007","307226002","307593001","307601000","307757001","309775007","31081000119101","312991009","314206003","314408000","314418005","314964006","314987003","314988008","314989000","314990009","314991008","314992001","314993006","314994000","314995004","314996003","314997007","314998002","314999005","315000005","315001009","315002002","315003007","315004001","315005000","315006004","315007008","315008003","315009006","31712002","31898008","326072005","32875003","3298001","33144001","33325001","33644002","3514002","353561000119103","353741000119106","359617009","359780007","359782004","359785002","359987004","361196000","363368005","363369002","363417006","363418001","363419009","363467004","363468009","363469001","363470000","363471001","363473003","363482009","363483004","364006","36599006","367363000","369455009","369456005","369457001","369458006","369459003","369460008","369461007","369464004","369467006","369468001","369476004","369477008","369478003","369479006","369480009","369481008","369482001","369484000","369486003","369488002","369491002","369492009","369500009","369501008","369502001","369514009","369521009","369523007","369530001","369535006","369536007","369538008","369540003","369542006","369543001","369544007","369545008","369546009","369553000","369554006","369555007","369556008","369557004","369558009","369560006","369561005","369562003","369563008","369564002","369565001","369568004","369569007","369570008","369571007","369572000","369573005","369574004","369575003","369576002","369577006","369578001","369581006","369582004","369583009","369584003","369585002","369586001","369588000","369589008","369590004","369591000","369592007","369593002","369602008","369603003","369604009","369605005","369606006","369607002","369608007","369609004","369610009","371024007","371026009","371139006","371967001","372003004","372093008","372119009","372142002","37688005","397767007","39871006","399969009","400058002","402563000","402879006","40312006","403906006","404090003","404091004","404092006","404093001","404094007","404122003","404123008","404124002","404156009","40425004","405570007","405843009","40640008","409622000","410430005","410431009","41309000","414676007","416780008","416975007","417996009","418304008","418529003","419728003","420054005","420614009","421023003","421283008","421529006","422782004","423032007","423384009","42343007","423595004","423987006","424052001","424151006","424276002","424404003","424887002","424954002","425303004","425369003","425390006","425413006","425500002","426012001","426263006","426373005","426437004","426611007","426896000","428051000124108","428061005","428173007","428351000124105","428700003","429033009","429161000124103","429458009","429998004","430771000124100","433146000","434431000124103","43736008","438511000","43904005","439567002","44047000","44088000","441481004","441530006","442344002","44274007","44313006","443144000","443253003","443254009","443343001","443344007","443493003","445236007","446221000","448218008","448248006","448250003","448863000","448989001","449253005","449420002","449630001","449631002","449632009","449633004","45256007","457721000124104","458321000124102","458581000124106","459371000124108","459381000124106","459391000124109","459401000124106","459411000124109","459421000124101","460561000124109","46113002","46177005","462172006","462174007","462175008","471880001","473419009","4817008","48447003","49049000","49584005","49708008","4981000","50196008","50325005","5053004","5148006","51615001","51928006","52448006","536002","5375005","54502004","54867000","55009008","55565007","56267009","56675007","56841008","57557005","57686001","58756001","59651006","59773008","60805002","60856006","609507007","6183001","6475002","65096006","65710008","66108005","66989003","67431000119105","67441000119101","67771000119102","67905004","681621000119105","681721000119103","68328006","684911000119105","69482004","698296002","698504006","698594003","698624003","698625002","698626001","698687007","698725008","698726009","698781002","698948009","698949001","698954005","698955006","699189004","699318007","699748007","700250006","700423003","702373006","702392008","703272007","703273002","703274008","703275009","703276005","704152002","704242009","704667004","705176003","707324008","707434003","70756004","708030004","709109004","709110009","709111008","709285002","70936005","71193007","712487000","712849003","713060000","713181003","713189001","713244007","713325002","713370005","713419002","713488003","713844000","715345007","715401008","715414009","715662009","715737004","715807002","715864007","715904005","716107009","716203000","716662004","717840005","718089001","718555006","718685006","71892000","719218000","720587009","721718003","721977007","722095005","722600006","722671009","722707001","722919003","722962002","722977005","722978000","722979008","722980006","722987009","723123001","723390000","723829000","724550005","724685000","724686004","724687008","724747009","724761004","724776007","724777003","724778008","72481000119103","724992007","725146001","725416005","725898002","725938001","725939009","725940006","73097000","733028000","733184002","733185001","733190003","733191004","733192006","733193001","733194007","733351008","735386008","735733008","735735001","735757008","7361000175106","7371000175103","7381000175100","7391000175102","7401000175100","7411000175102","7421000175106","74669004","74960003","762350007","762351006","762457009","762707000","76301009","766246000","767444009","767448007","770602005","770727008","771306007","774069007","776416004","77690003","780821007","781076008","78208005","782697005","783161005","783258000","783706007","783771003","784341001","785879009","78862003","788863007","788864001","788898005","788899002","788950000","789574002","792004","792907004","79341000119107","79955004","80479009","80614003","816205008","816984002","82351000119105","82361000119107","82371000119101","82381000119103","82523003","827186009","82959004","831000119103","83105008","83168008","83291003","833326008","836274002","836477007","836486002","838276009","840452004","840464007","840465008","84114007","846637007","85232009","86044005","860826006","86454000","865908007","866048009","866052009","86680006","870590002","87091000119101","87101000119106","87111000119109","87121000119102","871617000","871619002","87317003","87433001","88805009","89580002","89819002","90099008","90117007","90610005","90688005","90771000119100","90791000119104","90811000119100","90831000119105","91181000119105","91251000119105","91281000119103","92506005","93144003","93145002","93146001","93150008","9345005","93715005","93726004","93727008","93746009","93748005","93749002","93768004","93807001","93843007","93928006","93930008","93939009","93946000","93962006","93964007","94082003","94086000","94152006","94153001","94154007","94155008","94156009","94157000","94158005","94159002","94160007","94161006","94162004","94163009","94164003","94165002","94166001","94167005","94168000","94169008","94170009","94171008","94172001","94173006","94175004","94176003","94177007","94179005","94180008","94181007","94182000","94183005","94184004","94185003","94186002","94187006","94189009","94190000","94191001","94192008","94193003","94194009","94195005","94196006","94197002","94198007","94200001","94201002","94202009","94203004","94204005","94205006","94206007","94207003","94208008","94209000","94210005","94211009","94212002","94213007","94214001","94215000","94217008","94218003","94219006","94220000","94221001","94222008","94224009","94225005","94226006","94227002","94228007","94229004","94230009","94231008","94232001","94233006","94234000","94235004","94236003","94237007","94238002","94239005","94240007","94241006","94242004","94243009","94244003","94245002","94246001","94247005","94248000","94249008","94250008","94252000","94253005","94254004","94255003","94256002","94257006","94258001","94259009","94260004","94261000","94262007","94263002","94264008","94265009","94266005","94267001","94268006","94269003","94270002","94271003","94272005","94273000","94274006","94275007","94276008","94277004","94278009","94279001","94280003","94281004","94282006","94283001","94284007","94285008","94286009","94287000","94288005","94289002","94290006","94291005","94292003","94293008","94294002","94295001","94296000","94297009","94298004","94299007","94300004","94301000","94302007","94303002","94304008","94305009","94306005","94307001","94308006","94309003","94310008","94311007","94312000","94313005","94314004","94315003","94316002","94317006","94318001","94319009","94320003","94321004","94322006","94323001","94324007","94325008","94326009","94327000","94328005","94329002","94330007","94331006","94332004","94333009","94334003","94335002","94336001","94337005","94338000","94339008","94340005","94341009","94342002","94343007","94344001","94345000","94346004","94347008","94348003","94349006","94350006","94351005","94352003","94353008","94354002","94355001","94356000","94357009","94358004","94359007","94360002","94361003","94362005","94364006","94365007","94366008","94367004","94368009","94369001","94370000","94371001","94372008","94373003","94374009","94375005","94376006","94378007","94379004","94380001","94381002","94382009","94383004","94384005","94385006","94386007","94387003","94388008","94389000","94390009","94391008","94392001","94393006","94394000","94395004","94396003","94397007","94398002","94399005","94400003","94401004","94402006","94403001","94404007","94405008","94406009","94407000","94408005","94409002","94410007","94411006","94412004","94413009","94414003","94415002","94416001","94417005","94418000","94419008","94420002","94421003","94422005","94423000","94424006","94425007","94426008","94427004","94428009","94429001","94430006","94431005","94432003","94433008","94434002","94435001","94436000","94437009","94439007","94440009","94441008","94442001","94443006","94444000","94445004","94446003","94447007","94448002","94449005","94450005","94451009","94452002","94453007","94454001","94455000","94456004","94457008","94458003","94459006","94460001","94461002","94462009","94463004","94464005","94465006","94466007","94467003","94468008","94469000","94470004","94471000","94472007","94473002","94474008","94475009","94476005","94477001","94478006","94479003","94480000","94481001","94482008","94483003","94484009","94485005","94486006","94487002","94488007","94489004","94490008","94491007","94492000","94493005","94494004","94495003","94496002","94497006","94498001","94499009","94500000","94501001","94502008","94503003","94504009","94505005","94506006","94507002","94508007","94509004","94510009","94511008","94512001","94513006","94514000","94515004","94516003","94517007","94518002","94519005","94520004","94521000","94522007","94523002","94524008","94525009","94526005","94527001","94528006","94529003","94530008","94531007","94532000","94533005","94534004","94535003","94536002","94537006","94538001","94539009","94540006","94542003","94543008","94544002","94545001","94546000","94547009","94548004","94549007","94550007","94551006","94552004","94553009","94554003","94555002","94556001","94557005","94558000","94559008","94560003","94561004","94562006","94564007","94565008","94566009","94567000","94568005","94569002","94570001","94571002","94572009","94573004","94574005","94575006","94576007","94577003","94578008","94579000","94580002","94581003","94582005","94583000","94584006","94585007","94586008","94587004","94588009","94589001","94590005","94591009","94592002","94593007","94594001","94595000","94596004","94597008","94598003","94599006","94600009","94601008","94602001","94603006","94604000","94605004","94606003","94607007","94608002","94609005","94610000","94611001","94612008","94613003","94614009","94615005","94616006","94617002","94618007","94619004","94620005","94621009","94622002","94623007","94624001","94625000","94626004","94627008","94628003","94629006","94630001","94631002","94632009","94633004","94634005","94635006","94636007","94637003","94638008","94639000","94640003","94641004","94642006","94643001","94644007","94645008","94646009","94647000","94648005","94649002","94650002","94651003","94652005","94653000","94654006","94655007","94656008","94657004","94658009","94659001","94660006","94661005","94662003","94663008","94664002","94665001","94666000","94667009","94668004","94669007","94670008","94671007","94672000","94673005","94674004","94675003","94676002","94677006","94678001","94679009","94680007","94681006","94682004","94683009","95634003","96311000119109","96901000119105","96981000119102","97051000119105","97751000119108","99131000119108","9953008"]}}

function get_oid_codes(OidDict,oid,codeSystem){
   var oid_codes=OidDict[oid][codeSystem]
   return oid_codes
}
 



function epochConvert(timeconvter) {
    var time = new Date(timeconvter * 1000);
    return time;
}

function getAge(dateString) {
    var today = new Date();
    var birthDate = new Date(dateString);
    var age = today.getFullYear() - birthDate.getFullYear();
    var m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}



function conditions(patientData, section, code) {
    var condition = _.filter(patientData[section], function (i) {
       get_condition = i.codes["CPT"] ||i.codes["SNOMED-CT"];
        if (get_condition && get_condition.length> 0) {
            return code.includes(i.codes["CPT"]&&i.codes["CPT"][0] )||(i.codes["SNOMED-CT"]&&i.codes["SNOMED-CT"][0])
        }
    })
    return condition

}

function sortInDescending(section_data, colname) {
    var sorttime = _.sortBy(section_data, function (t) { return epochConvert(t[colname]) })
    return sorttime = sorttime.reverse();
}

getYear = (val) => new Date(val).getFullYear()


function result(pd, section, code) {
    var get_LOINC = _.filter(pd[section], function (v) {

        LOINC = v.codes["LOINC"] 
        if (LOINC && LOINC.length > 0) {
            return code.includes(v.codes["LOINC"][0])
        }
    });
    return get_LOINC
}

var final = [];
_.each(patientData, function (pdata) {
    tmp = {}
    tmp["Denom"] = 0
    tmp["Numer"] = 0
    tmp["Exclusion"] = 0
    tmp["Exceptions"] = 0
    tmp["outlier"] = 0

    pdob = getAge(epochConvert(pdata.birthdate))
    var get_SNOMEDCT_codes=get_oid_codes(OidDictionary,"2.16.840.1.113883.3.464.1003.113.12.1074","SNOMED-CT")
    get_conditions = conditions(pdata, "conditions", get_SNOMEDCT_codes)
    if (get_conditions.length > 0) {
        sorted = sortInDescending(get_conditions, "start_time")
        get_start_time = sorted[0]["start_time"]
        visit_year = getYear(epochConvert(get_start_time))
    }

    //DENOM

    if (pdob >= 18 && pdob <= 75 && visit_year == 2022) {
        tmp["Denom"] = 1
    }

    if (tmp["Denom"] == 0) {
        tmp["Numer"] = 0
        tmp["Exclusion"] = 0
        tmp["Exceptions"] = 0
        tmp["outlier"] = 0
    }


    //Exclusions
        getResult_code=get_oid_codes(OidDictionary,"2.16.840.1.113883.3.117.1.7.1.207","SNOMED-CT")
        qualify_procedures=conditions(pdata,"procedures",getResult_code)
        if(qualify_procedures.length>0){
        exclusion_sorted=sortInDescending(qualify_procedures,"start_time")
        exclusion_start_time=exclusion_sorted[0]["start_time"]
        exclusion_visit_year=getYear(epochConvert(exclusion_start_time))
           
        if (exclusion_visit_year==2022){
            tmp["Exclusion"]=1
        }
        else if(tmp["Denom"] ==1&&tmp["Exclusion"]==1){
            tmp["Numer"]=0
            tmp["Exceptions"] = 0
        }
    }

    //NUMER
    get_LOINC=get_oid_codes(OidDictionary,"2.16.840.1.113883.3.464.1003.198.12.1013","LOINC")
    getResult = result(pdata, "results", get_LOINC)
    if (getResult.length > 0) {
        sortedTime = sortInDescending(getResult, "time")
        get_result_year=sortedTime[0]["time"]
        svcYear_result =getYear(epochConvert(get_result_year))
       HbA1c_result  = sortedTime[0].values[0]["scalar"]
        if (HbA1c_result<9 && svcYear_result==2022) {
            tmp["Numer"] = 1
        }
        else {
            tmp["Numer"] = 0
            
        }
    }
    if (tmp["Denom"]==1 && tmp["Numer"] ==0 &&tmp["Exclusion"]==0 && tmp["Exceptions"]==0 ){
        tmp["outlier"]=1
      }

    final.push(tmp)
})
console.log(final)














































































































































































































