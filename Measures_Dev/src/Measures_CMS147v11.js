// const { isNil } = require('lodash');
var _ = require('underscore');
var reporting_startdate = new Date("01-01-2022")
var reporting_enddate = new Date("12-31-2022")



// var OidDictionary = { '2.16.840.1.113883.3.526.3.1253': { 'ICD-10-CM': ['T78.08XA', 'T78.08XD', 'T78.08XS', 'Z91.012'], 'SNOMED-CT': ['91930004', '213020009'] }, '2.16.840.1.113883.3.526.3.1256': { 'SNOMED-CT': ['294648008', '294649000', '294647003'] }, '2.16.840.1.113883.3.526.3.1254': { 'CVX': ['135', '140', '141', '144', '149', '150', '155', '158', '161', '166', '168', '171', '185', '186', '197', '205', '88'] }, '2.16.840.1.113883.3.526.3.1257': { 'SNOMED-CT': ['293112000', '293113005', '390796006', '420113004'] }, '2.16.840.1.113883.3.526.3.402': { 'CPT': ['90630', '90653', '90654', '90655', '90656', '90657', '90658', '90661', '90662', '90666', '90667', '90668', '90673', '90674', '90682', '90685', '90686', '90687', '90688', '90689', '90694', '90756'], 'HCPCS Level II': ['G0008', 'Q2034', 'Q2035', 'Q2036', 'Q2037', 'Q2038', 'Q2039'], 'SNOMED-CT': ['86198006'] }, '2.16.840.1.113883.3.526.3.1537': { 'SNOMED-CT': ['102263004', '226881001', '226885005', '229955000', '256442007', '256443002', '286550009', '303300008', '414074006'] }, '2.16.840.1.113883.3.526.3.1240': { 'HCPCS Level II': ['G0438', 'G0439'], 'SNOMED-CT': ['444971000124105', '456201000124103'] }, '2.16.840.1.113883.3.464.1003.101.12.1014': { 'CPT': ['99324', '99325', '99326', '99327', '99328', '99334', '99335', '99336', '99337'], 'SNOMED-CT': ['209099002', '210098006'] }, '2.16.840.1.113883.3.464.1003.101.12.1013': { 'CPT': ['99315', '99316'] }, '2.16.840.1.113883.3.526.3.1083': { 'CPT': ['90951', '90952', '90953', '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961', '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969', '90970', '99512'], 'SNOMED-CT': ['302497006'] }, '2.16.840.1.113883.3.464.1003.101.12.1016': { 'CPT': ['99341', '99342', '99343', '99344', '99345', '99347', '99348', '99349', '99350'], 'SNOMED-CT': ['185460008', '185462000', '185466002', '185467006', '185468001', '185470005', '225929007', '315205008', '439708006', '698704008', '704126008'] }, '2.16.840.1.113883.3.526.3.1255': { 'SNOMED-CT': ['315640000'] }, '2.16.840.1.113883.3.464.1003.101.12.1012': { 'CPT': ['99304', '99305', '99306', '99307', '99308', '99309', '99310', '99315', '99316', '99318'], 'SNOMED-CT': ['18170008', '207195004'] }, '2.16.840.1.113883.3.464.1003.101.12.1001': { 'CPT': ['99201', '99202', '99203', '99204', '99205', '99212', '99213', '99214', '99215'], 'SNOMED-CT': ['30346009', '37894004', '185463005', '185464004', '185465003', '3391000175108', '439740005'] }, '2.16.840.1.113883.3.464.1003.101.12.1080': { 'CPT': ['98966', '98967', '98968', '99441', '99442', '99443'], 'SNOMED-CT': ['185317003', '314849005', '386472008', '386473003', '401267002'] }, '2.16.840.1.113883.3.464.1003.101.12.1089': { 'CPT': ['98969', '98970', '98971', '98972', '99421', '99422', '99423', '99458'], 'HCPCS Level II': ['G0071', 'G2010', 'G2012', 'G2061', 'G2062', 'G2063'] }, '99211': { 'CPT': ['99211'] }, '2.16.840.1.113883.3.464.1003.101.12.1008': { 'CPT': ['99241', '99242', '99243', '99244', '99245'], 'SNOMED-CT': ['281036007', '77406008'] }, '2.16.840.1.113883.3.526.3.1012': { 'SNOMED-CT': ['185316007', '185317003', '185318008', '185320006', '185321005', '185349003', '185463005', '185465003', '270424005', '270427003', '270430005', '308335008', '308720009', '386473003', '390906007', '401267002', '401271004', '406547006', '438515009', '438516005', '445450000', '448337001', '87790002', '90526000'] }, '2.16.840.1.113883.3.526.3.1084': { 'CPT': ['90945', '90947', '90951', '90952', '90953', '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961', '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969', '90970'], 'SNOMED-CT': ['14684005', '225230008', '238318009', '238319001', '238321006', '238322004', '238323009', '428648006', '676002', '71192002'] }, '2.16.840.1.113883.3.464.1003.101.12.1024': { 'CPT': ['99391', '99392', '99393', '99394'] }, '2.16.840.1.113883.3.464.1003.101.12.1025': { 'CPT': ['99395', '99396', '99397'] }, '2.16.840.1.113883.3.464.1003.101.12.1027': { 'CPT': ['99411', '99412'] }, '2.16.840.1.113883.3.464.1003.101.12.1030': { 'CPT': ['99429'] }, '2.16.840.1.113883.3.464.1003.101.12.1026': { 'CPT': ['99401', '99402', '99403', '99404'] }, '2.16.840.1.113883.3.464.1003.101.12.1023': { 'CPT': ['99385', '99386', '99387'] }, '2.16.840.1.113883.3.464.1003.101.12.1022': { 'CPT': ['99381', '99382', '99383', '99384'] }, '2.16.840.1.113883.3.526.3.1252': { 'CPT': ['99201', '99202', '99203', '99204', '99205', '99212', '99213', '99214', '99215', '99241', '99242', '99243', '99244', '99245', '99304', '99305', '99306', '99307', '99308', '99309', '99310', '99315', '99316', '99318', '99324', '99325', '99326', '99327', '99328', '99334', '99335', '99336', '99337', '99341', '99342', '99343', '99344', '99345', '99347', '99348', '99349', '99350', '99381', '99382', '99383', '99384', '99385', '99386', '99387', '99391', '99392', '99393', '99394', '99395', '99396', '99397', '99401', '99402', '99403', '99404', '99411', '99412', '99429'], 'HCPCS Level II': ['G0438', 'G0439'], 'SNOMED-CT': ['30346009', '37894004', '18170008', '185460008', '185462000', '185463005', '185464004', '185465003', '185466002', '185467006', '185468001', '185470005', '207195004', '209099002', '210098006', '225929007', '281036007', '315205008', '3391000175108', '439708006', '439740005', '698704008', '704126008', '77406008'] }, '2.16.840.1.113883.3.526.3.1185': { 'SNOMED-CT': ['185900003', '185901004', '185902006', '416928007'] }, '2.16.840.1.113883.3.526.3.1007': { 'SNOMED-CT': ['183932001', '183964008', '183966005', '266721009', '269191009', '31438003', '35688006', '397745006', '407563006', '410534003', '410536001', '416098002', '428119001', '59037007', '62014003', '79899007'] }, '2.16.840.1.113883.3.526.3.1008': { 'SNOMED-CT': ['105480006', '160932005', '160934006', '182890002', '182895007', '182897004', '182900006', '182902003', '183944003', '183945002', '184081006', '185479006', '185481008', '224187001', '225928004', '266710000', '266966009', '275694009', '275936005', '281399006', '310343007', '373787003', '406149000', '408367005', '413310006', '413311005', '413312003', '416432009', '423656007', '424739004', '443390004', '713247000'] }, '2.16.840.1.113883.3.526.3.1009': { 'SNOMED-CT': ['107724000', '182856006', '182857002', '185335007', '224194003', '224198000', '224199008', '242990004', '266756008', '270459005', '309017000', '309846006', '419808006', '424553001'] } };


// function monthDiff(d1, d2) {
//     var months;
//     d1 = new Date(d1)
//     d2 = new Date(d2)

//     months = (d2.getFullYear() - d1.getFullYear()) * 12;
//     months -= d1.getMonth();
//     months += d2.getMonth();
//     return months <= 0 ? 0 : months;
// }
// function age_gt_eq_6(patient) {
//     var pdob = _.propertyOf(patient.ServiceDate);
//     var dd_mts = monthDiff(pdob, reporting_startdate)
//     if (dd_mts >= 6) {
//         return true;
//     } else {
//         return false;
//     }
// }

// 2.16.840.1.113883.3.464.1003.101.12.1008
// function qualifying_encounters(patient) {
//     var result = {}
//     //var result=[];
//     var eligible_visits = _.filter(patient.visit, function (num) { return new Date(num.ServiceDate) >= reporting_startdate && new Date(num.ServiceDate) <= reporting_enddate });
//    //  console.log(eligible_visits);

//     var oid = OidDictionary["2.16.840.1.113883.3.464.1003.101.12.1008"]
//     //console.log(oid);
    

//    result = _.find(eligible_visits, function (num) 
//     { 
    
//      return oid[num['code system']].includes(num.code); 

// });

//  console.log(result);


// //   if (!result){
// //     return false;
//   }else{
//     return true;
//   }
//     // console.log(JSON.stringify(result, undefined, 4) + "true");

// }

/**********************************************************************************************************/
function month_Diff(d1, d2) {
    var months;
    months = (d2.getFullYear() - d1.getFullYear()) * 12;
    months -= d1.getMonth();
    months += d2.getMonth();
    return months <= 0 ? 0 : months;
}
console.log(month_Diff(new Date(reporting_startdate),new Date(reporting_enddate)));



// function date_diff_in_days(d1,d2){
// const diffTime = Math.abs(d2 - d1);
// const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
// console.log(diffDays + " daysdff");
// }

// date_diff_in_days(new Date(reporting_startdate),new Date(reporting_enddate));


// date_diff_in_years = function(d1,d2) {
//     var startYear= d1.getFullYear(d1)
//      var endYear=d2.getFullYear(d2)
//     var years= startYear-endYear
//       //var years = Math.abs(years)
//     return years
// }
//  date_diff_in_years(new Date(reporting_startdate),new Date(reporting_enddate));


// function age_gt_eq_6(patient) {
//        var pdob = _.propertyOf(patient.ServiceDate);
//         console.log(pdob);
//         var dd_mts = monthDiff(pdob, reporting_startdate)
//         if (dd_mts >= 6) {
//             return true;
//         } else {
//             return false;
    //     }
    // }

var patient =
{
    "Firstname": "rashmika",
    "LastName": "mandanna",
    "DOB": "08-26-2021",
    "MRN": "1183028",
    "visit": [
        {
            "MRN": "1183028",
            "NPI": "1013955343",
            "ServiceDate": "03/29/2022",
            "Visit Reason": "Unlisted preventive medicine service",
            "code": "99429", 
            "code system": "CPT",
            "value set name": "Encounter-Influenza",
            "value set oid": "2.16.840.1.113883.3.526.3.1252"
        },
        {
            "MRN": "1183028",
            "NPI": "1013955343",
            "ServiceDate": "03/29/2020",
            "Visit Reason": "Unlisted preventive medicine service",
            "code": "99241", 
            "code system": "CPT",
            "value set name": "Encounter",
            "value set oid": ""
        },
        {
            "MRN": "1183028",
            "NPI": "1013955343",
            "ServiceDate": "03/29/2022",
            "Visit Reason": "Unlisted preventive medicine service",
            "code": "99429",
            "code system": "CPT",
            "value set name": "Encounter-Influenza",
            "value set oid": "2.16.840.1.113883.3.526.3.1252"
        }
    ]
}

// var svdate=_.propertyOf(patient.visit.ServiceDate);
// console.log(svdate)


console.log(patient['visit'])

var eligible_visits = _.filter(patient.visit, function (num) { return new Date(num.ServiceDate) >= reporting_startdate && new Date(num.ServiceDate) <= reporting_enddate });
 console.log(eligible_visits);

// age_gt_eq_6(patient);
// console.log(age_gt_eq_6(patient));

// var pdob = _.propertyOf(patient.visit);
// console.log(pdob);

